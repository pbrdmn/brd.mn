<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Floating Point Arithmetic and Why It Makes Cents / brd.mn</title>
  <meta name="description" content="With the current headlines being dominated by the collapse of the Silicon Valley Bank, it seems apt to share this recent coding mistake I made with floating point numbers">
  <link rel="canonical" href="https://brd.mn/articles/floating-point/">
  <link rel="alternate" type="application/rss+xml" title="RSS"
      href="https://brd.mn/rss.xml"><link rel="icon" href="https://brd.mn/images/logo@1x.jpg">
<meta name="theme-color" content="#fff">
<meta name="theme-color" content="#888488" media="(prefers-color-scheme: dark)">

<meta property="og:title" content="Floating Point Arithmetic and Why It Makes Cents">
<meta property="og:description" content="With the current headlines being dominated by the collapse of the Silicon Valley Bank, it seems apt to share this recent coding mistake I made with floating point numbers">
<meta property="og:type" content="article">
<meta property="og:url" content="https://brd.mn/articles/floating-point/">
<meta property="og:site_name" content="brd.mn">
<meta property="article:author" content="Philip Boardman">
<meta property="article:published_time" content="Wed Mar 15 2023 11:00:00 GMT+1100 (Australian Eastern Daylight Time)">
<meta property="og:image" content="https://brd.mn/articles/floating-point/andrew-spencer-eY7ioRbk2sY-unsplash.jpg">
  
  <style>:root{--foreground:#564b57;--background:#fff;--background2:#f3f2f4;--code-background:#3b3b3b;--link:#015fb6;--visited:#6c0b77}@media screen and (prefers-color-scheme:dark){:root{--foreground:#888488;--background:#050305;--background2:#160d16;--link:#5282c9;--visited:#8d71a3;--code-background:#030203}img{opacity:.7}}html{font-family:sans-serif;line-height:1.3;color:var(--foreground);background:var(--background)}@media (min-width:600px){html{font-size:1.125rem}}@media (min-width:900px){html{font-size:1.25rem}}body{margin:0 0 3rem;padding:0}main{padding:0 1rem;max-width:36rem;margin:1rem auto}a{color:var(--link)}a:visited{color:var(--visited)}a.logo{display:flex;align-items:center;flex-direction:row;text-decoration:none;color:var(--foreground)}a.logo img{margin-right:.5rem}h1,h2{font-weight:400}article.snippet{display:flex;margin:1rem 0 2rem}.snippet .thumb{margin-left:1rem;flex:1}.snippet .summary{flex:3}.snippet .summary h2{font-size:inherit;font-weight:inherit;margin:0}.snippet .summary p{margin:.5rem 0}footer{font-size:.8rem}footer>p{margin:.5rem 0}@media screen and (max-width:599px){article>img,header>img{margin:0 -1rem;width:calc(100% + 2rem);max-width:calc(100% + 2rem);border-radius:0}.snippet{flex-direction:column-reverse}.snippet .thumb{margin:0 0 .5rem}.snippet .thumb img{width:100%}}blockquote,pre{background:var(--background2);padding:1rem;margin:1rem -1rem;overflow:hidden}blockquote>:first-child{margin-top:0}blockquote>:last-child{margin-bottom:0}code{background:var(--background2)}@media print,(prefers-contrast:more){blockquote,pre{background:var(--background);outline:2px solid var(--background2)}}pre{white-space:pre-wrap;word-break:break-all}img{max-width:100%;height:auto;border-radius:.2rem}hr{height:.1rem;width:90%;background:var(--background2);border:0;margin:2rem auto}nav ul{margin:1rem 0;padding:0;display:flex;flex-wrap:wrap}nav li{list-style:none}nav li a{margin-right:1rem}@media (min-width:600px){blockquote,pre{border-radius:.5rem}pre[class*=language-]{border-radius:.3em}}@media print{:root{--foreground:#000;--background2:#fff}html{font-size:14px}main{max-width:100%}}</style>
      <link rel="stylesheet" type="text/css" href="/css/code.css">
  <script src="/js/timeAgo.js" defer></script>
</head>
  <body>
    <main>
      <h1><a class="logo" href="/" title="brd.mn"><img
      src="/images/logo@2x.webp"
      srcset="/images/logo@1x.webp 1x, /images/logo@2x.webp 2x, /images/logo@3x.webp 3x"
      width="64"
      height="64" 
      alt="Philip Boardman"
    > Philip Boardman</a></h1>

      <article>
  <header>
    <h1>Floating Point Arithmetic and Why It Makes Cents</h1>
      <img src="andrew-spencer-eY7ioRbk2sY-unsplash.jpg" alt="A person in silhouette appears to be floating above the ground" title="A person in silhouette appears to be floating above the ground" width="800" height="450">
  </header>

  <footer>
    Published <time datetime="2023-03-15" title="Published on 2023-03-15">on 2023-03-15</time>,
      updated <time datetime="2023-03-16" title="Updated on 2023-03-16">on 2023-03-16</time>
    in 
      <a href="/tags/programming/">#programming</a>
    
      <a href="/tags/code/">#code</a>
    
      <a href="/tags/ruby/">#ruby</a>
    
      <a href="/tags/math/">#math</a>
    
  </footer>

  <hr>

  <p>With the current headlines being dominated by the collapse of the Silicon Valley Bank, it seems apt to share this recent coding mistake I made with floating point numbers. My mistake did not cause and was not caused by the SVB collapse, but it occurred due to some work being done as a result of needing to modify systems that were previously built to use SVB.</p>
<p>As with many companies, we were regularly processing transactions through Silicon Valley Bank. We needed to quickly adjust our process to allow us to send the transfer through a different financial institution. Rather than taking the long route and modifying our whole payment process, I proposed to write a conversion script to run on the files generated by the existing system, as this would be quicker to implement, be lower risk for delivery, and have less chance of introducing new problems into the system, which has mostly been working well for years.</p>
<p>The setup for this file conversion is relatively standard as far as financial transfer files go. Ready through a 30-40 page PDF that outlines file structure and naming, which fields are required and the length and contents of each. Mostly boring details which are tedious, but important to get correct or the bank's system will reject the whole file and often not provide any useful error. As far as <a href="https://martinfowler.com/articles/developer-effectiveness.html">development cycles</a>, it would be quite painful if we needed several iterations to diagnose and resolve an issue.</p>
<p>However, all of that boring stuff turned out to be straightforward, and after we discovered a particular naming convention we needed to follow, the converted files worked the first time.</p>
<blockquote>
<p>The most pertinent detail in all of this was that our input file stored transaction values in decimal such as <code>40.62</code> where the new format used integers to store this same value in &quot;cents&quot; as <code>4062</code>.</p>
</blockquote>
<hr>
<h2>Enter the bug</h2>
<p>We had run several tests using previous transaction files to ensure our script would generate files acceptable for the bank's systems to ingest and process and were feeling confident. However when we ran the conversion of the live data for payments, it was noted that there was a discrepancy in the total payment amounts.</p>
<blockquote>
<p>The payment file included several hundred thousand dollars of transactions, but was short by $3.89.</p>
</blockquote>
<hr>
<h2>Diagnosing the issue</h2>
<p>Fortunately, I had also spent a few minutes writing a script to convert back while writing the conversion script. Doing this allowed me to diff the input file with a like-for-like display of what was included in the output file. This quickly highlighted where the problem was, which was everywhere, and what the problem was.</p>
<p>In the diff, this showed that the input value of <code>40.62</code> had been converted to <code>40.61</code>. For exactly 389 transactions recorded in the payment file, the amount to be transferred was off by one cent ($0.01). This quickly triggered memories of floating point errors, with the popular claim that such and such programming language is bad because</p>
<pre class="language-js"><code class="language-js"><span class="token number">0.1</span> <span class="token operator">+</span> <span class="token number">0.2</span> <span class="token operator">==</span> <span class="token number">0.3</span> <span class="token comment">// false</span><br><span class="token number">0.1</span> <span class="token operator">+</span> <span class="token number">0.3</span> <span class="token comment">// 0.30000000000000004</span></code></pre>
<h2>Floating point arithmetic</h2>
<blockquote>
<p>Floating point errors can occur when computers represent real numbers with a finite number of bits. This can result in rounding errors and inaccuracies in calculations. While these errors may seem small, they can accumulate over time and lead to significant discrepancies in the final results.</p>
</blockquote>
<p>Knowing what the problem was made it easy to pinpoint the line of software at fault. This line of code was able to correctly convert the dollar amount to cents <em>most</em> of the time. But had some cases like in the above, where the floating point representation of a number became &quot;almost correct&quot;.</p>
<pre class="language-ruby"><code class="language-ruby">amount_in_cents <span class="token operator">=</span> <span class="token punctuation">(</span>amount<span class="token punctuation">.</span>to_f <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_i</code></pre>
<p>The 'to_i' method in Ruby is used to convert the result of the mathematical operation 'amount.to_f * 100' to an integer. Which was the source of the problem, as sometimes this would result in a number <em>just a little</em> larger or smaller than the expected result. For numbers which were a little <em>larger</em>, the <code>to_i</code> function would truncate these, effectively rounding them down with worked in our favour. However for the numbers which were a little <em>smaller</em>, the <code>to_i</code> function would round them down a whole unit, so <code>40.62</code> would be converted to <code>4601</code>.</p>
<hr>
<h2>The fix is in</h2>
<p>To resolve this issue, we needed to explicitly round the result to the nearest integer, rather than truncating the number, which is accomplished in Ruby using the <code>.round</code> method.</p>
<pre class="language-ruby"><code class="language-ruby">amount_in_cents <span class="token operator">=</span> <span class="token punctuation">(</span>amount<span class="token punctuation">.</span>to_f <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span>round</code></pre>
<p>And then, after adding some tests to ensure these cases would forever be covered, a new file was generated and sent to the finance team for processing. The team checked the numbers and confirmed that everything added up.</p>
<hr>
<h2>A better solution</h2>
<p>After some further research, it appears that Ruby provides a standard library for <a href="https://ruby-doc.org/stdlib-3.1.0/libdoc/bigdecimal/rdoc/BigDecimal.html">BigDecimal</a>, which is actually the appropriate solution to use in this case. By casting our <code>amount</code> to a <code>BigDecimal</code> we can then apply our calculation of <code>* 100</code> without losing precision.</p>
<pre class="language-ruby"><code class="language-ruby">amount_in_cents <span class="token operator">=</span> <span class="token punctuation">(</span>BigDecimal<span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_i</code></pre>
<p>And as we have previously written unit tests covering these cases, we can be confident with our change.</p>

</article>
    </main>
  </body>
</html>